// 1. GLOBAL VARIABLES - These must be at the top so the bot has "Memory"
let chatHistory = []; 
let chatState = "asking_name"; 

// 2. AUTOMATIC POP-UP - Opens chat after 2 seconds
window.onload = () => {
    setTimeout(() => {
        const widget = document.getElementById('chat-widget');
        if(widget) widget.classList.add('open');
    }, 2000);
};

// Toggle Chat Visibility
function toggleChat() {
    document.getElementById('chat-widget').classList.toggle('open');
}

// Enter Key Support
function handleKeyPress(e) {
    if (e.key === 'Enter') sendMessage();
}

// 3. UI HELPER - Adds message bubbles to the screen
function addTutorMessage(text) {
    const chat = document.getElementById("chatArea");
    const tutorMsg = document.createElement("div");
    tutorMsg.className = "message tutor";
    tutorMsg.innerHTML = `<div class="bot-icon">ðŸ¤–</div><div class="text">${text}</div>`;
    chat.appendChild(tutorMsg);
    chat.scrollTop = chat.scrollHeight; // Auto-scroll to bottom
}

// 4. MAIN SEND LOGIC - Connects UI to the AI
async function sendMessage() {
    const input = document.getElementById("userInput");
    const question = input.value.trim();
    if (!question) return;

    const chat = document.getElementById("chatArea");

    // Display Student Message
    const userMsg = document.createElement("div");
    userMsg.className = "message student";
    userMsg.innerHTML = `<div class="text">${question}</div>`;
    chat.appendChild(userMsg);

    input.value = "";
    chat.scrollTop = chat.scrollHeight;

    // Send to the AI Backend
    await callAIBatch(question);
}

// 5. AI API CALL - Sends history so the bot knows what was said before
async function callAIBatch(question) {
    // Save current question to history
    chatHistory.push({ role: "user", content: question });

    try {
        const response = await fetch("https://ai-tutor-chatbot-ne61.onrender.com/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                message: question,
                history: chatHistory // CRITICAL: This prevents repetition
            })
        });
        
        if (!response.ok) throw new Error("Server Busy");

        const data = await response.json();
        
        // Save AI reply to history so it doesn't repeat greetings
        chatHistory.push({ role: "assistant", content: data.reply });
        
        addTutorMessage(data.reply);

    } catch (error) {
        // Friendly error for when the Render free-tier server is waking up
        addTutorMessage("I'm just waking up my brain! ðŸ§  Give me 5 seconds and please type that again.");
    }
}